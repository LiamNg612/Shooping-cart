<?php
session_start();
include_once 'db.inc.php';
function order_DB()
{
    $db = new PDO('sqlite:/var/www/order.db');
    // FETCH_ASSOC:
    // Specifies that the fetch method shall return each row as an
    // array indexed by column name as returned in the corresponding
    // result set. If the result set contains multiple columns with
    // the same name, PDO::FETCH_ASSOC returns only a single value
    // per column name.
    $db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
    return $db;
}
if(isset($_POST['method'])&&$_POST['method']=="checkout"){
    if(isset($_POST['cart'])&&isset($_POST['setting'])){
        $cmd=$_POST['setting'][0];
        $business=$_POST['setting'][1];
        $currency=$_POST['setting'][2];
        $charset=$_POST['setting'][3];
        $user=$_POST['setting'][4];
        if($user==NULL){
            $user="guest";
        }
        $salt = mt_rand();
        $cart=json_decode($_POST['cart'],true);
        $order_list=$currency.",".$business.",".$salt.",";
        $detail="";
        $total=0;
        for($i = 0;$i < count($cart);$i++){
            if($cart[$i]["QUANTITY"]<0||count($cart)==0){
                throw new Exception();
                exit();
            }
            $cart_info=ierg4210_prod_fetchOne($cart[$i]["PID"]);
            $total+=$cart[$i]["QUANTITY"]*$cart_info[0][PRICE];
            $cart[$i]["PRICE"]=$cart_info[0][PRICE];
            $cart[$i]["NAME"]=$cart_info[0][NAME];
            if(count($cart)-1!=$i){
            $order_list.=$cart[$i]["PID"].':'.$cart[$i]["QUANTITY"].','.$cart[$i]["PRICE"].',';
            $detail.=$cart[$i]["PID"].':'.$cart[$i]["QUANTITY"].','.$cart[$i]["PRICE"].',';
            }else{
            $order_list.=$cart[$i]["PID"].':'.$cart[$i]["QUANTITY"].','.$cart[$i]["PRICE"];
            $detail.=$cart[$i]["PID"].':'.$cart[$i]["QUANTITY"].','.$cart[$i]["PRICE"];
            }
        }
        $digest=hash_hmac('sha1',$order_list,$salt);
        global $db;
        $db = order_DB();
        $sql = "INSERT INTO ORDERS (DIGEST, USER, DETAIL, SALT,CMD,BUSINESS,CURRENCY) VALUES (?,?, ?, ?,?, ?,?);";//add a ; at the sql statement
        $q = $db->prepare($sql);
        $q->bindParam(1, $digest);
        $q->bindParam(2,$user);
        $q->bindParam(3, $order_list);
        $q->bindParam(4, $salt);
        $q->bindParam(5, $cmd);
        $q->bindParam(6, $business);
        $q->bindParam(7, $currency);
        if ($q->execute()){
            $order=array('custom_id' => $db->lastInsertId(), 'digest' => $digest,'order list'=>$order_list,'total'=>$total);
            echo json_encode($order);
        } else {
            throw new Exception();
            exit();
        }
    }
    
}
?>